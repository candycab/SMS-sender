<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rundell Kontroll</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ekstra styling for bedre mobile opplevelse */
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        .btn-primary:hover, .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-md">
        <div class="bg-white rounded-2xl shadow-xl p-6">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    ‚ö° Adgangskontroll
                </h1>
                <div class="flex items-center gap-2">
                    <span id="statusIndicator" class="text-sm text-gray-500">‚öôÔ∏è</span>
                    <button id="settingsBtn" class="p-2 text-gray-600 hover:text-blue-600 transition-colors" title="Innstillinger">
                        ‚öôÔ∏è
                    </button>
                </div>
            </div>

            <!-- Innstillinger Panel -->
            <div id="settingsPanel" class="mb-6 p-4 bg-gray-50 rounded-lg border hidden">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">üì± SMS Konfigurasjon</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">SMS Nummer:</label>
                        <input type="tel" id="smsNummer" class="w-full p-3 border border-gray-300 rounded-lg text-sm" placeholder="+4712345678">
                        <p class="text-xs text-gray-500 mt-1">Mobilnummer som skal motta SMS-kommandoene</p>
                    </div>

                    <button id="saveSettings" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        Lagre nummer
                    </button>
                </div>
            </div>

            <!-- Status meldinger -->
            <div id="configAlert" class="mb-4 p-3 bg-yellow-100 border border-yellow-400 rounded-lg">
                <div class="flex items-center gap-2 text-yellow-800">
                    ‚ö†Ô∏è <span class="font-medium">SMS nummer kreves!</span>
                </div>
                <p class="text-sm text-yellow-700 mt-1">Trykk p√• ‚öôÔ∏è for √• legge inn ditt mobilnummer.</p>
            </div>

            <div id="testModeAlert" class="mb-4 p-3 bg-blue-100 border border-blue-400 rounded-lg hidden"></div>

            <div id="statusMessage" class="p-4 rounded-lg mb-6 text-center font-medium hidden"></div>

            <!-- Pinkode -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Pinkode:</label>
                <input type="password" id="pinkode" class="w-full p-3 border border-gray-300 rounded-lg text-center text-lg font-mono" placeholder="1234" maxlength="4" value="1234">
            </div>

            <!-- Hovedknapper -->
            <div class="space-y-4">
                <button id="portBtn" class="btn-primary w-full text-white font-bold py-6 px-6 rounded-xl text-xl transition-all duration-200 flex items-center justify-center gap-3">
                    <span id="portSpinner" class="spinner hidden"></span>
                    <span id="portIcon">‚ö°</span>
                    <span>√Öpne Port (1s)</span>
                </button>

                <button id="rundellBtn" class="btn-secondary w-full text-white font-bold py-6 px-6 rounded-xl text-xl transition-all duration-200 flex items-center justify-center gap-3">
                    <span id="rundellSpinner" class="spinner hidden"></span>
                    <span id="rundellIcon">üö™</span>
                    <span>√Öpne Rundell (10s)</span>
                </button>
            </div>

            <!-- Informasjon -->
            <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                <div class="flex items-start gap-2">
                    <span class="text-gray-500 mt-0.5">‚ÑπÔ∏è</span>
                    <div class="text-sm text-gray-600">
                        <p class="font-medium mb-1">Hvordan bruke:</p>
                        <p>1. Konfigurer TextBee i innstillinger (‚öôÔ∏è)</p>
                        <p>2. Skriv inn riktig pinkode</p>
                        <p>3. Velg Port (1s puls) eller Rundell (10s puls)</p>
                        <p class="mt-2 text-xs text-gray-500">Port √•pnes i 1 sekund, Rundell i 10 sekunder</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let config = {
            apiKey: '481690bb-593a-4d0a-88db-f259fb74e4b2', // Fast API Key
            deviceId: '686b7e816cfc5b35ee8ff544', // Fast Device ID
            smsNummer: ''
        };

        let isLoading = false;

        // DOM elementer
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const configAlert = document.getElementById('configAlert');
        const testModeAlert = document.getElementById('testModeAlert');
        const statusMessage = document.getElementById('statusMessage');
        const statusIndicator = document.getElementById('statusIndicator');
        const portBtn = document.getElementById('portBtn');
        const rundellBtn = document.getElementById('rundellBtn');

        // Last inn konfigurasjon
        function loadConfig() {
            const saved = localStorage.getItem('textbee-config');
            if (saved) {
                try {
                    const savedConfig = JSON.parse(saved);
                    config.smsNummer = savedConfig.smsNummer || '';
                    
                    document.getElementById('smsNummer').value = config.smsNummer;
                } catch (e) {
                    console.error('Error loading config:', e);
                }
            } else {
                // Vis innstillinger f√∏rste gang
                settingsPanel.classList.remove('hidden');
            }
            updateUI();
        }

        // Lagre konfigurasjon
        function saveConfig() {
            config.smsNummer = document.getElementById('smsNummer').value;

            localStorage.setItem('textbee-config', JSON.stringify(config));
            
            // Skjul innstillinger automatisk etter lagring
            const isConfigured = config.smsNummer;
            if (isConfigured) {
                settingsPanel.classList.add('hidden');
            }
            
            updateUI();
            showStatus('‚úÖ SMS nummer lagret!', 'success');
        }

        // Oppdater UI basert p√• konfigurasjon
        function updateUI() {
            const isConfigured = config.smsNummer;
            
            configAlert.classList.toggle('hidden', isConfigured);
            
            // Auto-skjul innstillinger n√•r konfigurert
            if (isConfigured && !settingsPanel.classList.contains('hidden')) {
                settingsPanel.classList.add('hidden');
            }
            
            // Oppdater status indikator
            if (isConfigured) {
                statusIndicator.textContent = '‚úÖ Klar';
                statusIndicator.className = 'text-sm text-green-600 font-medium';
                settingsBtn.textContent = '‚öôÔ∏è';
                settingsBtn.title = 'Innstillinger';
            } else {
                statusIndicator.textContent = '‚öôÔ∏è SMS';
                statusIndicator.className = 'text-sm text-orange-600 font-medium';
                settingsBtn.textContent = '‚ö†Ô∏è';
                settingsBtn.title = 'SMS nummer kreves!';
            }
            
            // Skjul test mode alert alltid
            testModeAlert.classList.add('hidden');

            const pinkodeValue = document.getElementById('pinkode').value;
            portBtn.disabled = !isConfigured || isLoading || !pinkodeValue;
            rundellBtn.disabled = !isConfigured || isLoading || !pinkodeValue;
            
            // Endre knapp-stil basert p√• om det er konfigurert
            portBtn.style.opacity = (isConfigured && pinkodeValue) ? '1' : '0.5';
            rundellBtn.style.opacity = (isConfigured && pinkodeValue) ? '1' : '0.5';
        }

        // Vis status melding
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `p-4 rounded-lg mb-6 text-center font-medium`;
            
            if (type === 'success') {
                statusMessage.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                statusMessage.classList.add('bg-red-100', 'text-red-800');
            } else {
                statusMessage.classList.add('bg-blue-100', 'text-blue-800');
            }
            
            statusMessage.classList.remove('hidden');
            
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, type === 'error' ? 6000 : 4000);
        }

        // Send SMS kommando
        async function sendKommando(releNr) {
            if (!config.smsNummer) {
                showStatus('‚ùå SMS nummer mangler - sjekk innstillinger', 'error');
                return;
            }

            const pinkode = document.getElementById('pinkode').value;
            if (!pinkode) {
                showStatus('‚ùå Pinkode m√• fylles ut', 'error');
                return;
            }

            isLoading = true;
            updateUI();

            // Forskjellige tider: Port (1s) vs Rundell (10s)
            const sekunder = releNr === 1 ? 1 : 10;
            const type = releNr === 1 ? 'port' : 'rundell';
            
            // Vis loading spinner
            const spinner = document.getElementById(releNr === 1 ? 'portSpinner' : 'rundellSpinner');
            const icon = document.getElementById(releNr === 1 ? 'portIcon' : 'rundellIcon');
            spinner.classList.remove('hidden');
            icon.classList.add('hidden');
            
            showStatus(`√Öpner ${type}...`, 'info');
            
            const kommando = `p√• ${releNr} s${sekunder} ${pinkode}`;
            
            try {
                const targetNumber = config.smsNummer;
                
                // Send direkte til TextBee API
                const response = await fetch(`https://api.textbee.dev/api/v1/gateway/devices/${config.deviceId}/send-sms`, {
                    method: 'POST',
                    headers: {
                        'x-api-key': config.apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recipients: [targetNumber],
                        message: kommando
                    })
                });
                
                const result = await response.json();
                console.log('TextBee Response:', response.status, result);
                
                // TextBee kan returnere success selv om response.ok er false
                if (response.ok || result.success || response.status === 200) {
                    const message = releNr === 1 
                        ? `‚úÖ Port √•pnet i 1 sekund!`
                        : `‚úÖ Rundell √•pnet i 10 sekunder!`;
                    showStatus(message, 'success');
                    console.log('SMS Result:', result);
                } else {
                    throw new Error(result.message || result.error || 'SMS sending failed');
                }
                
            } catch (error) {
                console.error('SMS Error:', error);
                
                let errorMessage = 'Kunne ikke sende SMS';
                
                if (error.message === 'Failed to fetch' || error.name === 'TypeError') {
                    errorMessage = 'Nettverksfeil! Sjekk internettforbindelse og at TextBee app kj√∏rer.';
                } else {
                    errorMessage = error.message || 'Ukjent feil';
                }
                
                showStatus(`‚ùå ${errorMessage}`, 'error');
            } finally {
                isLoading = false;
                updateUI();
                
                // Skjul loading spinner
                spinner.classList.add('hidden');
                icon.classList.remove('hidden');
            }
        }

        // Event listeners
        settingsBtn.addEventListener('click', () => {
            settingsPanel.classList.toggle('hidden');
        });

        document.getElementById('saveSettings').addEventListener('click', saveConfig);

        portBtn.addEventListener('click', () => sendKommando(1));
        rundellBtn.addEventListener('click', () => sendKommando(2));

        document.getElementById('pinkode').addEventListener('input', updateUI);

        // Initialiser app
        loadConfig();
    </script>
</body>
</html>